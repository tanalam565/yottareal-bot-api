<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>

    <!-- Required IIS modules: ARR (Application Request Routing) + URL Rewrite -->
    <!-- Install from: https://www.iis.net/downloads/microsoft/application-request-routing -->

    <rewrite>
      <rules>
        <rule name="Proxy to Uvicorn" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <!-- Do not proxy IIS static files if you ever serve any -->
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
          </conditions>
          <action
            type="Rewrite"
            url="http://localhost:8000/{R:1}"
          />
        </rule>
      </rules>
    </rewrite>

    <!-- Forward client IP to FastAPI so rate limiting works correctly -->
    <httpProtocol>
      <customHeaders>
        <add name="X-Forwarded-For" value="{REMOTE_ADDR}" />
      </customHeaders>
    </httpProtocol>

    <!-- Increase timeouts for long Document Intelligence calls -->
    <security>
      <requestFiltering>
        <!-- 50MB upload limit — must match MAX_FILE_SIZE_MB in config.py -->
        <requestLimits maxAllowedContentLength="52428800" />
      </requestFiltering>
    </security>

    <!-- Disable IIS static file handler so all requests go to Uvicorn -->
    <handlers>
      <remove name="StaticFile" />
      <remove name="DirectoryListingModule" />
    </handlers>

  </system.webServer>

  <!--
    DEPLOYMENT STEPS FOR IIS:

    1. Install required IIS modules:
       - Application Request Routing (ARR):
         https://www.iis.net/downloads/microsoft/application-request-routing
       - URL Rewrite:
         https://www.iis.net/downloads/microsoft/url-rewrite

    2. Enable ARR proxy in IIS Manager:
       - Open IIS Manager
       - Click server name (root level)
       - Open "Application Request Routing Cache"
       - Click "Server Proxy Settings"
       - Check "Enable proxy" → Apply

    3. Install Redis for Windows:
       https://github.com/microsoftarchive/redis/releases
       Or use Azure Cache for Redis (recommended for production)

    4. Install Python dependencies:
       pip install -r requirements.txt

    5. Set environment variables (System → Advanced → Environment Variables):
       AZURE_OPENAI_API_KEY, AZURE_STORAGE_CONNECTION_STRING, REDIS_URL, etc.
       (All variables from your .env file)

    6. Start Uvicorn as a Windows service using NSSM:
       Download NSSM: https://nssm.cc/download
       nssm install YottaRealChatbot "C:\Python311\python.exe" "start.py"
       nssm set YottaRealChatbot AppDirectory "C:\path\to\your\backend"
       nssm start YottaRealChatbot

    7. Place this web.config in your IIS site root directory

    8. Point your IIS site to the backend folder
       (or a separate folder containing only this web.config)
  -->

</configuration>